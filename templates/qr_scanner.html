{% extends 'plantilla.html' %}

{% block title %}Escáner QR{% endblock %}

{% block body %}
<div class="container-fluid px-3 px-md-4 my-3 my-md-4">
    <div class="page-header fadeIn">
        <h1 class="h2">Escáner de QR</h1>
        <div>
            <a id="back-button" href="/admin" class="btn btn-primary">
                <i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">Volver</span>
            </a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10 col-xl-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white d-flex align-items-center py-3">
                    <i class="bi bi-qr-code-scan me-2 fs-5"></i>
                    <h5 class="mb-0 fs-6 fs-md-5">Escanea un código QR</h5>
                </div>
                <div class="card-body text-center position-relative p-3 p-md-4">
                    <div class="scanner-status" id="scanner-status">
                        <i class="bi bi-camera"></i> Escáner activo - Apunta al código QR
                    </div>
                    
                    <div id="video-container" class="shadow-lg mb-4" style="display: none;">
                        <video id="qr-video" autoplay playsinline></video>
                        <div class="scanner-overlay">
                            <div class="scanner-crosshair pulse-border"></div>
                            <div class="scanner-laser"></div>
                        </div>
                    </div>
                    
                    <canvas id="qr-canvas" style="display:none;"></canvas>
                    
                    <div class="qr-actions">
                        <button id="use-qr" class="btn btn-primary">
                            <i class="bi bi-camera me-2"></i> Iniciar Escáner
                        </button>
                        <button id="stop-scanner" class="btn btn-danger" style="display: none;">
                            <i class="bi bi-x-circle me-2"></i> Detener Escáner
                        </button>
                    </div>
                    
                    <div class="mt-4">
                        <div class="card bg-light border-0 shadow-sm">
                            <div class="card-body p-3">
                                <h6 class="text-muted mb-3">O ingresa el código manualmente</h6>
                                <div class="input-group">
                                    <input type="text" id="qr-input" class="form-control" placeholder="Escribe el código aquí" inputmode="text">
                                    <button id="verify-manual" class="btn btn-outline-primary">
                                        <i class="bi bi-check-lg"></i> <span class="d-none d-sm-inline">Verificar</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="qr-result" class="mt-4 shadow-sm">
                        <div class="card border-0">
                            <div class="card-header">
                                <h4 id="result-title" class="mb-0 fs-5">Resultado</h4>
                            </div>
                            <div class="card-body">
                                <p id="result-message" class="lead fs-6 fs-md-5"></p>
                                <div id="ticket-details" class="ticket-info mt-3" style="display: none;">
                                    <h5 class="border-bottom pb-2 mb-3">Información del Boleto</h5>
                                    <div id="ticket-data"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.3.1/dist/jsQR.min.js"></script>
<style>
    /* Estilos del escáner QR mejorados */
    #qr-canvas {
        width: 100%;
        height: auto;
    }
    
    #video-container {
        position: relative;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        border-radius: 12px;
        overflow: hidden;
        aspect-ratio: 4/3;
    }
    
    #qr-video {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 12px;
        box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    .scanner-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.2);
        border-radius: 12px;
        pointer-events: none;
    }
    
    .scanner-laser {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 2px;
        background: #ff4757;
        box-shadow: 0 0 8px #ff4757;
        animation: scan 2s infinite;
    }
    
    @keyframes scan {
        0% { top: 20%; }
        50% { top: 80%; }
        100% { top: 20%; }
    }
    
    .scanner-crosshair {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 220px;
        height: 220px;
        margin-top: -110px;
        margin-left: -110px;
        border: 3px solid rgba(255,255,255,0.7);
        border-radius: 16px;
        box-shadow: 0 0 0 3px rgba(0,0,0,0.3);
    }
    
    /* Responsive crosshair */
    @media (max-width: 576px) {
        .scanner-crosshair {
            width: 180px;
            height: 180px;
            margin-top: -90px;
            margin-left: -90px;
        }
    }
    
    .pulse-border {
        animation: pulseBorder 2s infinite;
    }
    
    @keyframes pulseBorder {
        0% { box-shadow: 0 0 0 0 rgba(24, 144, 255, 0.4); }
        70% { box-shadow: 0 0 0 15px rgba(24, 144, 255, 0); }
        100% { box-shadow: 0 0 0 0 rgba(24, 144, 255, 0); }
    }
    
    #qr-result {
        margin-top: 25px;
        border-radius: 10px;
        overflow: hidden;
        display: none;
    }
    
    #qr-result.success-bg {
        border-left: 5px solid #2ecc71;
    }
    
    #qr-result.error-bg {
        border-left: 5px solid #e74c3c;
    }
    
    .ticket-info {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
    }
    
    .scanner-status {
        font-weight: 600;
        margin-bottom: 20px;
        color: #6c757d;
        display: none;
        padding: 10px 15px;
        border-radius: 50px;
        background: #f1f5f9;
    }
    
    .scanner-status.active {
        display: inline-block;
        color: #3a86ff;
        background: #e9f2ff;
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { opacity: 0.6; }
        50% { opacity: 1; }
        100% { opacity: 0.6; }
    }
    
    .page-header {
        background-color: #fff;
        border-radius: 10px;
        padding: 1rem 1.25rem;
        margin-bottom: 1.25rem;
        box-shadow: 0 6px 15px -3px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .dark-mode .page-header {
        background-color: #2d3748;
        border: 1px solid #3a465a;
    }
    
    .dark-mode .ticket-info,
    .dark-mode .scanner-status {
        background-color: #2d3748;
        color: #e2e8f0;
    }
    
    .dark-mode .scanner-status.active {
        background-color: rgba(58, 134, 255, 0.15);
        color: #3a86ff;
    }
    
    .qr-actions {
        display: flex;
        gap: 15px;
        justify-content: center;
        margin: 20px 0;
        flex-wrap: wrap;
    }
    
    .qr-actions .btn {
        padding: 12px 25px;
        font-weight: 600;
        border-radius: 50px;
        min-width: 180px;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Más optimizaciones para móvil */
    @media (max-width: 576px) {
        .page-header h1 {
            font-size: 1.5rem;
        }
        
        .qr-actions .btn {
            min-width: 140px;
            width: 100%;
            padding: 10px 15px;
            font-size: 0.95rem;
        }
        
        #video-container {
            max-width: 100%;
            aspect-ratio: 1/1;
        }
        
        .ticket-info {
            padding: 10px;
        }
        
        /* Touch-friendly input */
        #qr-input, .input-group .btn {
            padding: 12px;
            font-size: 16px;
        }
        
        .card-body {
            padding: 1rem;
        }
    }
    
    /* Animaciones */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fadeIn {
        animation: fadeIn 0.5s ease forwards;
    }
    
    /* Botones más táctiles en móvil */
    @media (max-width: 768px) {
        .badge-lg {
            font-size: 0.85rem !important;
        }
        
        input, button, .btn {
            font-size: 16px !important;
        }
        
        /* Scroll suave para el resultado */
        #qr-result:not([style*="display: none"]) {
            scroll-margin-top: 20px;
        }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elementos DOM
        const video = document.getElementById('qr-video');
        const videoContainer = document.getElementById('video-container');
        const canvasElement = document.getElementById('qr-canvas');
        const canvas = canvasElement.getContext('2d');
        const useButton = document.getElementById('use-qr');
        const stopButton = document.getElementById('stop-scanner');
        const qrResult = document.getElementById('qr-result');
        const resultMessage = document.getElementById('result-message');
        const resultTitle = document.getElementById('result-title');
        const ticketDetails = document.getElementById('ticket-details');
        const ticketData = document.getElementById('ticket-data');
        const qrInput = document.getElementById('qr-input');
        const verifyManual = document.getElementById('verify-manual');
        const scannerStatus = document.getElementById('scanner-status');
        const backButton = document.getElementById('back-button');

        let scanning = false;
        let currentQrCode = null;
        let videoStream = null;
        let scanMode = null;
        let lastScannedCode = null;
        let scanInterval = null;
        
        // Detección del dispositivo
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            // Ajustes específicos para móviles
            document.querySelectorAll('.qr-actions .btn').forEach(btn => {
                btn.classList.add('w-100');
            });
        }

        // Configurar botón de regreso según la URL o referrer
        const urlParams = new URLSearchParams(window.location.search);
        const source = urlParams.get('source');
        const referrerPath = document.referrer ? new URL(document.referrer).pathname : '';
        
        // Corregido: usamos la sintaxis correcta para Jinja en lugar de JSX
        const isAdmin = "{{ 'true' if session.get('is_admin', False) else 'false' }}" === "true";
        
        if (source === 'admin' || referrerPath.includes('/admin')) {
            backButton.href = '/admin';
            backButton.innerHTML = '<i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">Volver al Panel Admin</span>';
        } else if (referrerPath.includes('/home')) {
            backButton.href = '/home';
            backButton.innerHTML = '<i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">Volver a Ventas</span>';
        } else {
            // Si no hay una página de referencia clara, comprueba si el usuario es admin
            if (isAdmin) {
                backButton.href = '/admin';
                backButton.innerHTML = '<i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">Volver al Panel Admin</span>';
            } else {
                backButton.href = '/home';
                backButton.innerHTML = '<i class="bi bi-arrow-left"></i> <span class="d-none d-sm-inline">Volver a Ventas</span>';
            }
        }

        // Optimización: almacenar la página de origen para futuras navegaciones
        localStorage.setItem('lastPage', backButton.href);

        useButton.addEventListener('click', function() {
            scanMode = 'use';
            startScanner();
        });
        
        stopButton.addEventListener('click', function() {
            stopScanner();
        });
        
        verifyManual.addEventListener('click', function() {
            const manualQrCode = qrInput.value.trim();
            if (manualQrCode) {
                currentQrCode = manualQrCode;
                useQrCode(manualQrCode);
                qrInput.value = '';
            }
        });
        
        // También permitir enviar con Enter en el input manual
        qrInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                verifyManual.click();
            }
        });

        // Función optimizada de inicio del escáner
        async function startScanner() {
            if (scanning) return;
            
            // Actualizar UI
            useButton.style.display = 'none';
            stopButton.style.display = 'inline-flex';
            scannerStatus.classList.add('active');
            qrResult.style.display = 'none';
            
            try {
                // Solicitar acceso a la cámara con mejor manejo de errores
                const constraints = { 
                    video: { 
                        facingMode: "environment", 
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                // En dispositivos iOS más antiguos, usar un enfoque diferente
                if (/(iPad|iPhone|iPod)/g.test(navigator.userAgent) && 
                    !window.MSStream && 
                    !('mediaDevices' in navigator)) {
                    // Fallback para dispositivos iOS antiguos
                    videoStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
                } else {
                    videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                }
                
                video.srcObject = videoStream;
                videoContainer.style.display = 'block';
                scanning = true;
                
                // Esperar a que el video esté listo
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play().then(resolve).catch(error => {
                            console.error("Error al reproducir video:", error);
                            resolve(); // Continuar de todos modos
                        });
                    };
                });
                
                // Limpiar cualquier intervalo previo
                if (scanInterval) {
                    clearInterval(scanInterval);
                }
                
                // Usar intervalo para controlar la frecuencia de escaneo
                // Ajustar intervalo según el dispositivo para mejor rendimiento
                const scanIntervalTime = isMobile ? 200 : 100;
                lastScannedCode = null;
                scanInterval = setInterval(scanFrame, scanIntervalTime);
                
            } catch (error) {
                console.error("Error al acceder a la cámara:", error);
                
                if (error.name === 'NotAllowedError') {
                    showMessage("Permiso denegado: Por favor, permite el acceso a la cámara.", "error");
                } else if (error.name === 'NotFoundError') {
                    showMessage("No se encontró ninguna cámara en este dispositivo.", "error");
                } else if (error.name === 'NotReadableError') {
                    showMessage("La cámara está siendo utilizada por otra aplicación.", "error");
                } else {
                    showMessage("Error al acceder a la cámara: " + error.message, "error");
                }
                
                resetScannerUI();
            }
        }

        // Función optimizada para escanear frames
        function scanFrame() {
            if (!scanning) return;
            
            // Verificar que el video tenga datos válidos
            if (video.readyState !== video.HAVE_ENOUGH_DATA) return;
            
            try {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code && code.data) {
                    // Evitar escanear el mismo código repetidamente
                    if (code.data !== lastScannedCode) {
                        lastScannedCode = code.data;
                        currentQrCode = code.data;
                        
                        // Sonido de éxito y feedback visual
                        beep();
                        
                        // Detener escáner y procesar el código
                        clearInterval(scanInterval);
                        stopScanner();
                        useQrCode(code.data);
                    }
                }
            } catch (error) {
                console.error('Error al escanear el frame:', error);
                // Continuar escaneando a pesar del error
            }
        }

        // Detener el escáner con limpieza mejorada
        function stopScanner() {
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => {
                    if (track.readyState === 'live') {
                        track.stop();
                    }
                });
                videoStream = null;
            }
            
            if (video.srcObject) {
                video.srcObject = null;
            }
            
            videoContainer.style.display = 'none';
            scanning = false;
            resetScannerUI();
        }
        
        // Restablecer UI después de escanear
        function resetScannerUI() {
            useButton.style.display = 'inline-flex';
            stopButton.style.display = 'none';
            scannerStatus.classList.remove('active');
        }
        
        // Verificar código QR
        function verifyQrCode(qrCode) {
            fetch(`/scan/${qrCode}?verify=true`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === "válido") {
                        showMessage(`${data.message}`, "success");
                        displayTicketInfo(data.ticket);
                    } else {
                        showMessage(`${data.message}`, "error");
                        ticketDetails.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Error al verificar el código QR: ' + error.message, "error");
                });
        }
        
        // Usar código QR
        function useQrCode(qrCode) {
            // Mostrar un estado de carga
            showMessage("Procesando código...", "info");
            
            fetch(`/scan/${qrCode}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error en la respuesta del servidor: ' + response.status);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.status === "válido") {
                        showMessage(`${data.message}`, "success");
                        displayTicketInfo(data.ticket);
                    } else {
                        showMessage(`${data.message}`, "error");
                        ticketDetails.style.display = 'none';
                    }
                    
                    // Hacer scroll al resultado en móviles
                    if (isMobile) {
                        setTimeout(() => {
                            qrResult.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }, 300);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showMessage('Error al procesar el código QR: ' + error.message, "error");
                });
        }
        
        // Mostrar mensaje de resultado con mejor estilo
        function showMessage(message, type) {
            resultMessage.textContent = message;
            qrResult.style.display = 'block';
            
            qrResult.classList.remove('success-bg', 'error-bg');
            
            if (type === "success") {
                qrResult.classList.add('success-bg');
                resultTitle.textContent = "¡ÉXITO! PUEDES ACCEDER AL EVENTO.";
                resultTitle.className = "mb-0 text-success";
            } else if (type === "error") {
                qrResult.classList.add('error-bg');
                resultTitle.textContent = "¡¡¡CUIDADO!!! REVISA TU BOLETO.";
                resultTitle.className = "mb-0 text-danger";
            } else {
                resultTitle.textContent = "Información";
                resultTitle.className = "mb-0 text-info";
            }
        }
        
        // Mostrar información del boleto con mejor estilo y responsividad
        function displayTicketInfo(ticket) {
            if (ticket) {
                ticketDetails.style.display = 'block';
                
                let usadoClass = ticket.usado ? 'text-white bg-danger' : 'text-white bg-success';
                let vipClass = ticket.vip ? 'text-dark bg-warning' : 'text-white bg-secondary';
                
                let html = `
                    <div class="row g-3">
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 h-100 shadow-sm">
                                <div class="card-body p-3">
                                    <h6 class="text-muted mb-1 small">Número de Boleto</h6>
                                    <h4 class="mb-0">#${ticket.boleto}</h4>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card border-0 h-100 shadow-sm">
                                <div class="card-body p-3">
                                    <h6 class="text-muted mb-1 small">Tipo de Boleto</h6>
                                    <span class="badge ${vipClass} badge-lg fs-6 px-3 py-2">${ticket.vip ? 'VIP' : 'Normal'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card border-0 shadow-sm mb-3">
                        <div class="card-body p-3">
                            <h6 class="text-muted mb-1 small">Estado del Boleto</h6>
                            <div class="d-flex align-items-center">
                                <span class="badge ${usadoClass} badge-lg fs-6 px-3 py-2">${ticket.usado ? 'Usado' : 'Disponible'}</span>
                                ${!ticket.usado ? '<span class="ms-2 text-success"><i class="bi bi-check-circle-fill"></i> Listo para usar</span>' : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // Añadir información adicional si existe
                if (ticket.email || ticket.fecha_creacion || ticket.vendedor) {
                    html += `
                        <div class="card border-0 shadow-sm">
                            <div class="card-body p-3">
                                <h6 class="text-muted mb-3 small">Información adicional</h6>
                                <div class="row g-2">
                                    ${ticket.email ? `
                                        <div class="col-12 col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-envelope-fill text-primary me-2"></i>
                                                <div class="text-truncate" title="${ticket.email}">${ticket.email}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${ticket.vendedor ? `
                                        <div class="col-12 col-md-6">
                                            <div class="d-flex align-items-center mb-2">
                                                <i class="bi bi-person-fill text-primary me-2"></i>
                                                <div class="text-truncate" title="Vendedor: ${ticket.vendedor}">Vendedor: ${ticket.vendedor}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    ${ticket.fecha_creacion ? `
                                        <div class="col-12 col-md-6">
                                            <div class="d-flex align-items-center">
                                                <i class="bi bi-calendar-fill text-primary me-2"></i>
                                                <div>Fecha: ${ticket.fecha_creacion}</div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                ticketData.innerHTML = html;
            } else {
                ticketDetails.style.display = 'none';
            }
        }
        
        // Sonido de beep mejorado al detectar QR con fallback seguro
        function beep() {
            try {
                // Intentar reproducir un sonido más agradable
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (AudioContext) {
                    const context = new AudioContext();
                    const oscillator = context.createOscillator();
                    const gainNode = context.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(context.destination);
                    
                    oscillator.type = 'sine';
                    oscillator.frequency.value = 1800;
                    gainNode.gain.value = 0.1;
                    
                    oscillator.start(0);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, context.currentTime + 0.3);
                    oscillator.stop(context.currentTime + 0.3);
                } else {
                    // Fallback para navegadores que no soportan AudioContext
                    const beepSound = new Audio('data:audio/wav;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU'+Array(1e3).join('A'));
                    beepSound.volume = 0.3;
                    beepSound.play().catch(e => console.log('No se pudo reproducir el audio: ' + e));
                }
            } catch (error) {
                console.log('Error al reproducir sonido:', error);
            }
            
            // Vibración si es compatible (móvil)
            if ('vibrate' in navigator) {
                navigator.vibrate(200);
            }
        }
        
        // Detector de inactividad para detener el escáner automáticamente
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            if (scanning) {
                // Detener el escáner después de 2 minutos de inactividad
                inactivityTimer = setTimeout(() => {
                    stopScanner();
                    showMessage("Escáner detenido por inactividad", "info");
                }, 120000); // 2 minutos
            }
        }
        
        // Eventos para resetear el temporizador de inactividad
        document.addEventListener('touchstart', resetInactivityTimer);
        document.addEventListener('mousemove', resetInactivityTimer);
        document.addEventListener('keypress', resetInactivityTimer);
        
        // Detener el escáner cuando se cambia de pestaña o se minimiza
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState !== 'visible' && scanning) {
                stopScanner();
            }
        });
        
        // Limpiar recursos al descargar la página
        window.addEventListener('beforeunload', function() {
            if (scanning) {
                stopScanner();
            }
        });
    });
</script>
{% endblock %}